import React, { useEffect } from 'react';

export interface WidgetProps {
  className?: string;
  style?: React.CSSProperties;
  theme?: 'light' | 'dark';
  sourceChainId?: string | number;
  destChainId?: string | number;
  onSwapComplete?: (params: { txHash: string }) => void;
  apiKey?: string;
}

export function Widget(props: WidgetProps) {
  const { className, style, theme, sourceChainId, destChainId, onSwapComplete } = props;

  const url = new URL('https://fswap.luminite.app');
  url.searchParams.set('theme', theme || 'light');
  url.searchParams.set('type', 'widget');

  if (sourceChainId) {
    url.searchParams.set('sourceChainId', sourceChainId.toString());
  }
  if (destChainId) {
    url.searchParams.set('destChainId', destChainId.toString());
  }
  if (apiKey) {
    url.searchParams.set('apiKey', apiKey);
  }

  useEffect(() => {
    if (!onSwapComplete) return;

    const allowedOrigin = url.origin;

    const handleMessage = (event: MessageEvent) => {
      if (event.origin !== allowedOrigin) return;

      const data = event.data as { name?: string; txHash?: string };
      if (data && typeof data === 'object' && data.name === 'swapComplete') {
        const { name: _, ...rest } = data;
        onSwapComplete(rest as { txHash: string });
      }
    };

    window.addEventListener('message', handleMessage);
    return () => {
      window.removeEventListener('message', handleMessage);
    };
  }, [onSwapComplete, url.origin]);

  return (
    <iframe
      src={url.toString()}
      className={`${className || ''}`}
      style={{
        width: '100%',
        height: '640px',
        ...style,
      }}
      title="FSwap Bridge Widget"
      allow="publickey-credentials-get *; publickey-credentials-create *; clipboard-write"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
    />
  );
}

export function MyWidget() {
  return (
    <Widget
      theme="dark"
      sourceChainId="xrpl:mainnet"
      destChainId="eip155:14"
      onSwapComplete={(params) => {
        console.log('Swap completed:', params);
      }}
      apiKey="ak_505fbee71c6da93f344977b16aaa3b9d4c00d35b2685001d07255278d4af11f1"
    />
  );
}