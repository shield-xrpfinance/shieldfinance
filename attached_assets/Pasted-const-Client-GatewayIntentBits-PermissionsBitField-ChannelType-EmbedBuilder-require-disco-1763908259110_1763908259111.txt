const { Client, GatewayIntentBits, PermissionsBitField, ChannelType, EmbedBuilder } = require('discord.js');

const client = new Client({ intents: [GatewayIntentBits.Guilds] });

const TOKEN = process.env.DISCORD_BOT_TOKEN;
const GUILD_ID = process.env.DISCORD_GUILD_ID;

client.once('ready', async () => {
  console.log(`Logged in as ${client.user.tag}`);

  const guild = client.guilds.cache.get(GUILD_ID);
  if (!guild) return console.error('Guild not found');

  // === 1. CREATE CHANNELS (you already have this) ===
  const createCategory = async (name, channels) => {
    const category = await guild.channels.create({ name, type: ChannelType.GuildCategory });
    for (const ch of channels) {
      await guild.channels.create({
        name: ch.name,
        type: ch.type ?? ChannelType.GuildText,
        topic: ch.topic || null,
        parent: category,
        permissionOverwrites: ch.overwrites || [],
      });
    }
    return category;
  };

  // (keep your existing channel creation here or skip if already done
  // ... (same as before)

  // === 2. NEW: CREATE ROLES ===
  const roles = [
    { name: 'Shield Holder', color: '#00FFAA', hoist: true },
    { name: 'Staker', color: '#0099FF', hoist: true },
    { name: 'Dev', color: '#FF0066' },
    { name: 'Moderator', color: '#FFAA00', permissions: ['ManageMessages', 'KickMembers', 'BanMembers'] },
    { name: 'Community Helper', color: '#AA66FF' },
  ];

  for (const role of roles) {
    await guild.roles.create({
      name: role.name,
      color: role.color,
      hoist: role.hoist || false,
      permissions: role.permissions || [],
    }).catch(() => {}); // ignore if exists
  }
  console.log('Roles created');

  // === 3. NEW: SET UP WELCOME MESSAGE + RULES EMBED ===
  const welcomeChannel = guild.channels.cache.find(c => c.name === 'start-here');
  if (welcomeChannel) {
    const embed = new EmbedBuilder()
      .setTitle('Welcome to Shield Finance')
      .setDescription('Institutional-grade XRP liquid staking & multi-asset vaults on XRPL')
      .setColor('#00FFAA')
      .addFields(
        { name: 'Step 1', value: 'Read <#rules>' },
        { name: 'Step 2', value: 'React below to verify wallet & unlock channels' },
        { name: 'Useful Links', value: '[Website](https://shield.finance) • [Docs](https://docs.shield.finance) • [GitHub](https://github.com/shield-xrpfinance/shieldfinance)' }
      )
      .setThumbnail(guild.iconURL())
      .setTimestamp();

    await welcomeChannel.send({ content: '@everyone', embeds: [embed] });
    await welcomeChannel.send('React with Shield to get the **Shield Holder** role');
  }

  // === 4. NEW: AUTO-ROLE ON REACTION (simple version) ===
  const message = await welcomeChannel.messages.fetch({ limit: 1 }).then(m => m.first());
  if (message) await message.react('Shield');

  client.on('messageReactionAdd', async (reaction, user) => {
    if (reaction.message.channel.name !== 'start-here' || user.bot) return;
    if (reaction.emoji.name === 'Shield') {
      const member = await guild.members.fetch(user.id);
      const role = guild.roles.cache.find(r => r.name === 'Shield Holder');
      if (role) member.roles.add(role);
    }
  });

  console.log('All done! Channels + roles + welcome system ready');
  // Remove the line below if you want the bot to stay online for the reaction listener
  // client.destroy();
});

client.login(TOKEN);